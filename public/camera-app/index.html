<!--
    Copyright (C) 2025, Paul Hammant

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Live Verify</title>
    <link rel="stylesheet" href="../styles.css">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@6/dist/tesseract.min.js'></script>
    <script src='https://unpkg.com/psl@1.15.0/dist/psl.umd.cjs'></script>
    <script>
      window.cvReady = new Promise(resolve => {
        window.__onCvReady = resolve;
      });
    </script>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="cv['onRuntimeInitialized']=()=>window.__onCvReady && window.__onCvReady();"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="appTitle">Live Verify</h1>
            <p>(simulation of potential change to iPhone and Android camera app)</p>
            <div id="buildTimestamp" style="display: none; font-size: 0.8rem; margin-top: 10px; opacity: 0.8;"></div>
        </header>

        <main>
            <div class="camera-section">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="overlay"></canvas>
                    <button id="captureBtn" class="shutter-btn" style="display: none;" title="Capture & Verify"></button>
                    <div id="debugConsole" style="display: none;"></div>

                    <!-- Success overlay - camera-native feel -->
                    <div id="successOverlay" class="verification-overlay" style="display: none;">
                        <div class="overlay-content success">
                            <div class="overlay-icon">‚úì</div>
                            <div class="overlay-text">Claim Verified</div>
                            <div class="overlay-domain" id="successDomain"></div>
                        </div>
                        <div class="overlay-tap-hint">Tap to continue</div>
                    </div>

                    <!-- Failure overlay - brief, then shows details -->
                    <div id="failureOverlay" class="verification-overlay" style="display: none;">
                        <div class="overlay-content failure">
                            <div class="overlay-icon">‚úó</div>
                            <div class="overlay-text">Verification Failed</div>
                            <div class="overlay-subtext" id="failureReason"></div>
                        </div>
                        <div class="overlay-tap-hint">Tap for details</div>
                    </div>

                    <!-- Processing overlay -->
                    <div id="processingOverlay" class="verification-overlay" style="display: none;">
                        <div class="overlay-content processing">
                            <div class="overlay-spinner"></div>
                            <div class="overlay-text" id="processingText">Processing...</div>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button id="startCamera" class="btn btn-primary">Enable Camera</button>
                    <button id="retakeBtn" class="btn btn-primary" style="display: none;">Retake</button>
                    <button id="stopCamera" class="btn btn-secondary" disabled>Stop Camera</button>
                </div>
            </div>

            <div class="results-section">
                <div class="status-indicator" id="statusIndicator">
                    <div class="status-icon">üì∑</div>
                    <div class="status-text">Ready to scan</div>
                </div>
                <div class="status-indicator" id="captureInfo" style="display: none;">
                    <div class="status-text" id="captureMethod">Capture method: -</div>
                    <div class="status-text" id="captureResolution">Resolution: -</div>
                </div>

                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill"></div>
                    <div class="progress-text">Processing...</div>
                </div>

                <div class="result-card" id="textResult" style="display: none;">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="captured">Captured Image</button>
                        <button class="tab-btn" data-tab="extracted">Extracted Text</button>
                        <button class="tab-btn" data-tab="normalized">Normalized Text</button>
                    </div>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab-captured">
                            <img id="croppedImage" style="max-width: 100%; border: 1px solid #e2e8f0; border-radius: 8px;" />
                            <div style="margin-top: 15px;">
                                <button id="copyImage" class="btn btn-small">üìã Copy Image to Clipboard</button>
                                <button id="downloadImage" class="btn btn-small" style="display: none; margin-left: 10px;">üíæ Download Image</button>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-extracted">
                            <pre id="extractedText"></pre>
                        </div>
                        <div class="tab-pane" id="tab-normalized">
                            <textarea id="normalizedText" rows="10" style="width: 100%; font-family: monospace; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;"></textarea>
                            <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">You can edit the text above to fix OCR errors. Hash will automatically recalculate.</p>
                        </div>
                    </div>
                </div>

                <div class="result-card" id="hashResult" style="display: none;">
                    <h3>SHA-256 Hash</h3>
                    <div class="hash-value" id="hashValue"></div>
                    <button id="copyHash" class="btn btn-small">Copy Hash</button>
                </div>

                <div class="result-card" id="verificationResult" style="display: none;">
                    <h3>Verification Status</h3>
                    <div class="verification-status" id="verificationStatus"></div>
                    <div class="verification-url" id="verificationUrl"></div>
                    <div id="verificationDisclaimer" style="display: none; margin-top: 15px; padding: 12px; background-color: #fef5e7; border-left: 4px solid #f39c12; font-size: 0.85rem; color: #856404;">
                        <div style="margin-bottom: 8px;">‚ö†Ô∏è <strong>Only the text within the registration marks has been verified</strong></div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Screencaps of this verified message are not proof of anything</div>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button id="verifyAnotherBtn" class="btn btn-primary" style="display: none;">Verify Another</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <details>
                <summary>How it works</summary>
                <ol>
                    <li>Point camera at document with registration marks</li>
                    <li>Tap shutter to capture and verify</li>
                </ol>
            </details>
            <p>
                <a href="../training-pages/">Training</a> ¬∑
                <a href="../PRIVACY-DECLARATION.html">Privacy</a> ¬∑
                <a href="https://github.com/paul-hammant/live-verify" target="_blank">Source</a>
            </p>
        </footer>
    </div>

    <script src="../cv/geometry.js"></script>
    <script src="../cv/detectSquares.js"></script>
    <script src="../normalize.js"></script>
    <script src="../app-logic.js"></script>
    <script src="../domain-authority.js"></script>
    <script src="../live-verify-app.js"></script>
</body>
</html>
