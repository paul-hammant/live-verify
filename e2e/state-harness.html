<!--
    Copyright (C) 2025, Paul Hammant

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Machine Test Harness - Verific</title>
    <link rel="stylesheet" href="../public/styles.css">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src='https://unpkg.com/psl@1.15.0/dist/psl.umd.cjs'></script>
    <script>
      window.cvReady = new Promise(resolve => {
        window.__onCvReady = resolve;
      });
    </script>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="cv['onRuntimeInitialized']=()=>window.__onCvReady && window.__onCvReady();"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>State Machine Test Harness</h1>
            <p>For testing state transitions in Playwright E2E tests</p>
        </header>

        <main>
            <div class="camera-section">
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="overlay"></canvas>
                    <button id="captureBtn" class="shutter-btn" style="display: none;" title="Capture & Verify">‚≠ò</button>
                    <div id="debugConsole" style="display: none;"></div>
                </div>

                <div class="controls">
                    <button id="startCamera" class="btn btn-primary">Enable Camera</button>
                    <button id="retakeBtn" class="btn btn-primary" style="display: none;">Retake</button>
                    <button id="stopCamera" class="btn btn-secondary" disabled>Stop Camera</button>
                </div>
            </div>

            <div class="results-section">
                <div class="status-indicator" id="statusIndicator">
                    <div class="status-icon">üì∑</div>
                    <div class="status-text">Ready to scan</div>
                </div>
                <div class="status-indicator" id="captureInfo" style="display: none;">
                    <div class="status-text" id="captureMethod">Capture method: -</div>
                    <div class="status-text" id="captureResolution">Resolution: -</div>
                </div>

                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill"></div>
                    <div class="progress-text">Processing...</div>
                </div>

                <div class="result-card" id="textResult" style="display: none;">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="captured">Captured Image</button>
                        <button class="tab-btn" data-tab="extracted">Extracted Text</button>
                        <button class="tab-btn" data-tab="normalized">Normalized Text</button>
                    </div>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab-captured">
                            <img id="croppedImage" style="max-width: 100%; border: 1px solid #e2e8f0; border-radius: 8px;" />
                            <div style="margin-top: 15px;">
                                <button id="copyImage" class="btn btn-small">üìã Copy Image to Clipboard</button>
                                <button id="downloadImage" class="btn btn-small" style="display: none; margin-left: 10px;">üíæ Download Image</button>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab-extracted">
                            <pre id="extractedText"></pre>
                        </div>
                        <div class="tab-pane" id="tab-normalized">
                            <textarea id="normalizedText" rows="10" style="width: 100%; font-family: monospace; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;"></textarea>
                        </div>
                    </div>
                </div>

                <div class="result-card" id="hashResult" style="display: none;">
                    <h3>SHA-256 Hash</h3>
                    <div class="hash-value" id="hashValue"></div>
                    <button id="copyHash" class="btn btn-small">Copy Hash</button>
                </div>

                <div class="result-card" id="verificationResult" style="display: none;">
                    <h3>Verification Status</h3>
                    <div class="verification-status" id="verificationStatus"></div>
                    <div class="verification-url" id="verificationUrl"></div>
                    <div id="verificationDisclaimer" style="display: none; margin-top: 15px; padding: 12px; background-color: #fef5e7; border-left: 4px solid #f39c12; font-size: 0.85rem; color: #856404;">
                        ‚ö†Ô∏è Screencaps of this verified message are not proof of anything
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button id="verifyAnotherBtn" class="btn btn-primary" style="display: none;">Verify Another</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p style="text-align: center; font-size: 0.9rem; color: #666;">
                State Machine Test Harness for E2E Testing
            </p>
        </footer>
    </div>

    <script src="../public/cv/geometry.js"></script>
    <script src="../public/cv/detectSquares.js"></script>
    <script src="../public/normalize.js"></script>
    <script src="../public/app-logic.js"></script>
    <script src="../public/domain-authority.js"></script>
    <script src="../public/app-url-based.js"></script>
</body>
</html>
